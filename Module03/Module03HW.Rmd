---
title: "Module03HW"
author: "Diana McSpadden"
UID: hdm5s
date: "9/10/2020"
output: html_document
---

# Assignment: Stat 6021: Homework Set 3

### Name: H. Diana McSpadden
### UID: hdm5s

**Attended a Study Group With**: David Fuentes, Jing Huang, Caprill Wright, Arne Newman, Michael Kastanowski, Abby Bernhardt, Loren Bushkar

### References
In addition to the textbook and Module 3, I also read: https://data.library.virginia.edu/interpreting-log-transformations-in-a-linear-model/


## Question 1 (No R required) 

In your own words, try to explain the following question an undergraduate student asks you: "Why do we transform the response variable when the constant variance assumption is not met, instead of transforming the predictor variable?"

**Answer**
A lack of constant variance means that as x changes, the difference between The predicted y and actual y is increasing, decreasing, or displaying some other pattern, i.e. the variance of e|x changes as x changes. Transforming x would not have an affect on the lack of constant (yi - yi-hat) , because x would still be changing values even with the transformation, the variance is still affected.

I would also show them the formula for the variance of y given x:

Var(Y|x) = Var(B0 + B1(x) + e|x) 

I would explain that both B0 and B1 are fixed values, and y's non-stable variance is based on x. 

V(y|x) = Var(CONSTANT + e|x)

Var(y|x) = Var(e|x) == sigma^2

The only way to create a constant sigms^2 is to transform y.

Therefor, to fix issues with constant variance, we transform y to provide a constant/fixed sigma^2.

Transforming x will not actually transform the variance of y.

## Question 2
For this question, we will use the cornnit data set from the faraway package. Be sure to install and load the faraway package first, and then load the data set. The data explore the relationship between corn yield (bushels per acre) and nitrogen (pounds per acre) fertilizer application in a study carried out in Wisconsin.

```{r q2loaddata}
library(faraway)
#summary(cornnit)

head(cornnit, 5)
attach(cornnit)

cornnit

```


### 2a:What is the response variable and predictor for this study? 
**Answer**
The predictor variable is **nitrogen**

The response variable is **yield**


Create a **scatterplot** of the data, and interpret the scatterplot.

```{r q2ascatterplot}
# create a model
cornModel <- lm(yield~nitrogen)

#plot the model and the linear model
plot(x=nitrogen, y=yield, main='Plot Corn Yield Against Nitrogen', xlab = 'Nitrogen (lbs per acre)', ylab = 'Yield (bushels per acre')
abline(cornModel,col="red")

```
**Interpretation**
While the yield appears to increase as nitrogen increases, the points are not evenly spread above and below the linear model, and the variance appears smaller at the 100 and 300 nitrogen levels. I need to see more.



### 2b: Fit a linear regression without any transformations. 

**Create the corresponding residual plot.** 
```{r q2bregressionplot}
plot(cornModel$fitted.values,cornModel$residuals, main="Plot of Residuals against Fitted Values")
abline(h=0,col="red")
```

**Based only on the residual plot, what transformation will you consider first? Be sure to explain your reason.**
**Answer**

The residual plot both displays a lack of standard variance in the residuals and a non-0 mean of the residuals. I recommend a transformation on the response variable first, to attempt to address the variance issue, because it may also address the non-zero mean issue.

I recommend an inverse y transformation because the original scatter plot resembles a negative curvature. I do not see a y limit demonstrated in the plot which would recommend a log transformation.

### 2c: Create a Box Cox plot for the profile log likelihoods. 
```{r q2cBoxCox}

library(MASS)
#boxcox(cornModel)
boxcox(cornModel, lambda = seq(1.4, 4.5, 0.01))

```
**How does this plot aid in your data transformation?**
0 does not lie within the confidence interval, thus, we do not recommend a ln transformation.

1 does not lie within the confidence interval, thus I recommend applying a transformation to the response variable: yield.

### 2d: Perform the necessary transformation to the data. 
Refit the regression with the transformed variable(s) and assess the regression assumptions. You may have to apply transformations a number of times. Be sure to explain the reason behind each of your transformations. Perform the needed transformations until the regression assumptions are met. What is the regression equation that you will use?
 
Note: in part 2d, there are a number of solutions that will work. You must clearly document your reasons for each of your transformations.


**First**, I am going to start with the variance issue, because it may address the non-zero mean issue.

I believe the original scatter plot demonstrates a negative curvature, indicating an inverse transformation on y.


```{r q2dTransform1}
# y' = 1/y
inv.yield <- 1/yield 
cornModel.invy <-lm(inv.yield~nitrogen)
#residual plot of transformed y
plot(cornModel.invy$fitted.values,cornModel.invy$residuals, main="TRANSFORMED: Plot of Residuals against Fitted Values")
abline(h=0,col="red")
```

The inverse transformation, one its own did not address the residual variance in the cornnit data. Additional transformations are needed if there is a simple linear relationship between nitrogen and yield.

I will attempt to address the non-zero mean of residuals with a transformation of the x variable: nitrogen.

Because of the 0 values, before applying a inverse function a correction to the x value must be made. The correction will be determined by investigating the min value of x, then correcting all values by + (min-non-zero(x)/2). Then a 1/x transformation will be applied.

The residual plot of the 1/y transformation will be placed next to the residual plot of the 1/y & 1/x transformation for comparison.

```{r qdTransformation2}

par(mfrow=c(1,2))
plot(cornModel.invy$fitted.values,cornModel.invy$residuals, main="TRANSFORM 1: 1/y")
abline(h=0,col="red")


#x' = (x + ((min(x)/2)))
minimumNonZeroNit = min(nitrogen[nitrogen > 0])
inv.nitrogen = 1 / (nitrogen + (minimumNonZeroNit /2))
cornModel.invyx <-lm(inv.yield~inv.nitrogen)
#residual plot of transformed y
plot(cornModel.invyx$fitted.values,cornModel.invyx$residuals, main="TRANSFORM 2: 1/y & 1/(transformed x)")
abline(h=0,col="red")


```
The 1/x transformation successfully addresses the non-zero mean of the residuals, but also results in two clusters. The clusters represent the data results where 0 nitrogen was applied to the field, and where nitrogen was applied to the field. 

The lack of constant variance is caused by the data for fields where no nitrogen was applied to the field. If these data were excluded the constant variance and the non-0 mean of residuals may be addressed and a linear model made possible.


Checking the Box-Cox after the 1/y transformation can confirm, or not, the y transformation.

These show that that the 1/y is not the correct response variable transformation.
```{r}
par(mfrow=c(1,2))
boxcox(cornModel.invy, lambda = seq(-4, -1.2, 0.01))

boxcox(cornModel.invyx, lambda = seq(-3, -1, 0.01))
```

1 is not within the 95% CI for lambda, thus, the 1/y transformation was not an appropriate choice for a transformation.

Attempt a y' = y^2 on the cornModel.invyx the based on the cornModel.invyx model's Box-Cox. This is done understanding that there will not be a straightforward linearization of the model.

Plot the residual plot and Box-Cox for this model

```{r}
secondtrans.yield = inv.yield^(-2)

cornModel.secondyinvx <-lm(secondtrans.yield~inv.nitrogen)

par(mfrow=c(1,2))

plot(cornModel.secondyinvx$fitted.values,cornModel.secondyinvx$residuals, main="1/x (1/y)^-2: Residuals against Fitted Values")
abline(h=0,col="red")

boxcox(cornModel.secondyinvx, lambda = seq(0.5, 2, 0.01))
```

1 is now within my CI for lambda after the (1/y)^-2. The residual plot demonstrated that the mean of the residuals is approximately 0, and the variance of the residuals appears approximately standard. I now have a model that appears to meet several of the linear model assumptions, ***but** I have two clusters of values.

My current transformations are:
x' = 1/x
y'1 = (1/y)
y'2 = (y'1)^-2


Before attempting additional transformation, residual correlation or lack of correlation is of interest to determine if additional linear model assumptions are violated. The ACF graph with the original data set is presented.

```{r q2dACFComparisonTransformation1}
par(mfrow=c(1,1))
acf(cornModel.secondyinvx$residuals, main="ACF of Residuals: 1/x, (1/y)^-2")

```

The ACF chart shows no correlation between residuals after the transformations.

I must still address the 2 clusters of values. I believe these are caused by the nitrogen = 0 

Removing nitrogen = 0 values will change the inquiry to: "When nitrogen has been applied to field, is there a linear relationship between yield, and nitrogen amount?"

First, create a new data set that has removed the x = 0 values.

```{r q2dRemovex=0}
#head(cornnit)
cornnitFiltered = cornnit[cornnit[, "nitrogen"]>0, ]

cornnitFilteredModel = lm(cornnitFiltered$yield~cornnitFiltered$nitrogen)
#head(cornnitFiltered)
```

Compare the the following (each is a row in a 2 x 2 comparison of plots)
1. Original data set scatter plot to 0-filtered data set scatter plot
2. Original data set residual plot to 0-filtered data set residual plot


``` {r q2dRunScatterResidualPlots}
par(mfrow=c(2,2))

# Original data set scatter plot
plot(x=cornnit$nitrogen, y=cornnit$yield, main='Original Scatter Plot', xlab = 'Nitrogen (lbs per acre)', ylab = 'Yield (bushels per acre')
abline(cornModel,col="red")

# 0-filtered data set scatter plot
plot(x=cornnitFiltered$nitrogen, y=cornnitFiltered$yield, main='0-Filtered Scatter Plot', xlab = 'Nitrogen (lbs per acre)', ylab = 'Yield (bushels per acre')
abline(cornnitFilteredModel,col="red")

# Original data set residual plot
plot(cornModel$fitted.values,cornModel$residuals, main="Original Residuals Plot")
abline(h=0,col="red")

# 0-filtered data set residual plot
plot(cornnitFilteredModel$fitted.values,cornnitFilteredModel$residuals, main="0-Filtered Residual Plot")
abline(h=0,col="red")
```

The non-zero residual mean issue has been addressed by removing the x = 0 values.

We must investigate if the correlation of the residuals has been addressed by removing the x = 0 values.

Plot the Original data set ACF plot and compare to the 0-filtered data set ACF plot

``` {r q2dACFComparison}
par(mfrow=c(1,2))

# Original ACF
acf(cornModel$residuals, main="ACF of Residuals: Original")

# 0-filtered ACF
acf(cornnitFilteredModel$residuals, main="ACF of Residuals: 0-Filtered")
```
From the ACF plots we see that removing the x = 0 values has addressed the correlation of residuals issue.

Let's look at the p value from the filtered model which demonstrated we do not yet have a reliable linear model.

```{r}
summary(cornnitFilteredModel)
```
!!!!!!
HELP HERE !!!!!
The model does meet the critical value test, but the F-statistic is not statistically significant.
!!!!!!

There is still issue of the non-standard variance of the residuals. I will investigate the Box-Cox for the 0-filtered dataset.
```{r}
par(mfrow=c(1,1))
boxcox(cornnitFilteredModel, lambda = seq(-2, 5, 0.01))
```
Both 0 and 1 are within the CI of lambda. The peak is closer to 1, which indicates we do not need to transform the response variable.

I want to compare plots of three models:
1. the original data set: ORIGINAL
2. the  1/x, (1/y)^-2: MANY TRANSFORMATIONS
3. the 0-filtered: 0-FILTERED



``` {r q2dRunPlots}
par(mfrow=c(1,3))

# Original data set residual plot
plot(cornModel$fitted.values,cornModel$residuals, main="ORIGINAL")
abline(h=0,col="red")

# 1/x (1/y)^-2
plot(cornModel.secondyinvx$fitted.values,cornModel.secondyinvx$residuals, main="MANY TRANSFORMATIONS")
abline(h=0,col="red")

# 0-filtered
plot(cornnitFilteredModel$fitted.values,cornnitFilteredModel$residuals, main="0 filtered")
abline(h=0,col="red")

```
The 0-filtered model appears to address the variance and mean-0 assumptions, and does not create the two-cluster problem.

I also want to compare the three models on the ACF plot:
```{r}
par(mfrow=c(1,3))

# Original ACF
acf(cornModel$residuals, main="ORIGINAL")

# 1/x (1/y)^-2 ACF
acf(cornModel.secondyinvx$residuals, main="ORIGINAL")

# 0-filtered ACF
acf(cornnitFilteredModel$residuals, main="0 Filtered")
```
Both the "MANY TRANSFORMATIONS" and "0-Filtered" models address the correlation of residuals issue in the original model.

What are the summaries for each model?

```{r}
summary(cornModel.secondyinvx)
```
The "Many Transformations" model is statistically significant based on the p-value.

```{r}
summary(cornnitFilteredModel)
```


**Conclusion:**

If we need to include the nitrogen=0 observations in our model, then the 1/x, (1/y)^-2 model meets the assumptions necessary for a linear model. However, this model is difficult to express in a linearized function.

If we change the hypothesis to whether there is a linear relationship between yield and nitrogen applied, only when a non-zero amount of nitrogen is applied, then the 0-filtered model, with no transformations get's us close to a linear model, but the F-statistic is still not significant.

**My conclusion is that we need more predictor data than nitrogen applied to predict yield using a linear model.**

## Question 3 (No R required) 
A chemist studied the concentration of a solution, y, over time, x, by fitting a simple linear regression. The scatterplot of the dataset, and the residual plot from the regression model are shown in Figure 1.


### 3a: Based only on Figure 1, would you recommend transforming the predictor, x, or the response, y,first? 
Briefy explain your choice.

**Answer**
I recommend transforming the response variable first because by addressing the lack of constant variance of the residuals which I do see in the scatter plot. By transforming the response variable, we may be able to address the non-zero mean of the residuals.

### 3b: The profile log-likelihoods for the parameter, gamma, of the Box-Cox power transformation, is shown in Figure 2. 
Your classmate says that you should apply a log transformation to the response variable first. Do you agree with your classmate?
Be sure to justify your answer.

**Answer**
Yes, I do agree with my classmate, because 0 is within the 95% CI for gamma, which, based on Module 3 instruction, indicates a natural log transformation will be helpful to reduce residual variance. Response variable variance was apparent in the residual plot in Figure 1.

### 3c: Your classmate is adament on applying the log transformation to the response variable, and fits the regression model. 
The R output is shown in Figure 3. Write down the estimated regression equation for this model. 
How do we interpret the regression coefficients B1-hat and B0-hat in context?

**Answer**
After transformation, the regression coefficients are:
B0-hat: 1.50792

B1-hat: -0.44993

The chemist is studying the concentration of a solution over time.

A ln transformation was applied to the response variable, y.

**Interpretation of B1 after an ln transformation on y**
For each change in x, y changes by the multiple (-)exp(0.44993).

If we want to present this as a percentage:

y, the solution concentration, decreases by (exp(0.44993) - 1) * 100 % == **decreases by 56.8202%** for every unit increase in x, time.

```{r}
(exp(0.44993) - 1) * 100
```

**Interpretation of B0 after an ln transformation on y**
The y intercept is ln(B0). In our case, the y intercept is exp(1.50792) (e^1.50792), or 4.5173.
```{r}
exp(1.50792)
```
When time is 0, the concentration is 4.5173.



